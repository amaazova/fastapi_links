# FastAPI URL Shortener API

Этот проект представляет собой API для сервиса сокращения URL, реализованный с использованием FastAPI, SQLAlchemy и Celery. API позволяет:

- Регистрировать новых пользователей и выполнять аутентификацию.
- Генерировать access и refresh токены для доступа к защищённым эндпоинтам.
- Создавать, обновлять, удалять и получать статистику по сокращённым URL.
- Работать как с приватными ссылками (привязанными к пользователю), так и с публичными.
- Автоматически очищать просроченные и неактивные ссылки с помощью фоновых задач (Celery).

---

## Оглавление

- [API эндпоинты](#api-эндпоинты)
  - [Пользовательские эндпоинты](#пользовательские-эндпоинты)
  - [Эндпоинты для ссылок](#эндпоинты-для-ссылок)
  - [Фоновые задачи](#фоновые-задачи)
- [Примеры запросов](#примеры-запросов)
- [Инструкция по запуску](#инструкция-по-запуску)
  - [Локальный запуск без Docker](#локальный-запуск-без-docker)
  - [Запуск с Docker и Docker Compose](#запуск-с-docker-и-docker-compose)
- [Описание базы данных](#описание-базы-данных)
  - [Таблица `users`](#таблица-users)
  - [Таблица `links`](#таблица-links)
- [Заключение](#заключение)

---

## API эндпоинты

### Пользовательские эндпоинты

#### Регистрация пользователя
- **Метод:** `POST`
- **Путь:** `/users/register`
- **Описание:** Регистрация нового пользователя.
- **Тело запроса (JSON):**
  - `username` (string) — имя пользователя.
  - `password` (string) — пароль.
- **Ответ:** Объект пользователя с полями:
  - `id`
  - `username`

---

#### Аутентификация и получение токенов
- **Метод:** `POST`
- **Путь:** `/users/token`
- **Описание:** Аутентификация пользователя и получение access/refresh токенов.
- **Тело запроса:** Данные формы (OAuth2PasswordRequestForm):
  - `username`
  - `password`
- **Ответ:** JSON объект с:
  - `access_token`
  - `refresh_token`
  - `token_type` (обычно `"bearer"`)

---

#### Обновление токена
- **Метод:** `POST`
- **Путь:** `/users/token/refresh`
- **Описание:** Обновление access токена с использованием refresh токена.
- **Тело запроса (JSON):**
  - `refresh_token` — refresh токен.
- **Ответ:** JSON объект с новыми:
  - `access_token`
  - `refresh_token`
  - `token_type`

---

#### Получение ссылок пользователя
- **Метод:** `GET`
- **Путь:** `/users/links`
- **Описание:** Получение списка ссылок, созданных аутентифицированным пользователем.
- **Аутентификация:** Требуется Bearer токен.
- **Ответ:** Массив объектов ссылок.

---

### Эндпоинты для ссылок

#### Создание сокращённой ссылки (для аутентифицированных пользователей)
- **Метод:** `POST`
- **Путь:** `/shorten`
- **Описание:** Создание новой сокращённой ссылки, привязанной к пользователю.
- **Аутентификация:** Bearer токен обязателен.
- **Тело запроса (JSON):**
  - `original_url` (string, URL) — оригинальный URL.
  - `custom_alias` (string, опционально) — пользовательский алиас (только алфавитно-цифровые символы).
  - `category` (string, опционально) — категория ссылки.
  - `expires_at` (datetime, опционально) — дата истечения срока действия. Поддерживаются различные форматы:
    - `YYYY-MM-DDTHH:MM:SS.SSSZ`
    - `DD.MM.YYYY HH:MM`
    - `YYYY-MM-DD HH:MM:SS`
    - `YYYY-MM-DDTHH:MM:SS`
    - `YYYY-MM-DD`
  - `is_public` (boolean, опционально) — флаг, указывающий, является ли ссылка публичной (по умолчанию `false`).
- **Ответ:** Объект созданной ссылки со следующими полями:
  - `id`
  - `original_url`
  - `short_code`
  - `created_at`
  - `expires_at`
  - `redirect_count`
  - `last_redirect_at`
  - `owner_id`
  - `category`
  - `is_public`

---

#### Создание публичной сокращённой ссылки
- **Метод:** `POST`
- **Путь:** `/shorten/public`
- **Описание:** Создание публичной сокращённой ссылки. Здесь не требуется аутентификация.
- **Тело запроса:** Как и для обычного создания ссылки, но `owner_id` будет `null`, а флаг `is_public` установлен в `true`.
- **Ответ:** Объект созданной ссылки.

---

#### Поиск ссылок
- **Метод:** `GET`
- **Путь:** `/search`
- **Описание:** Поиск ссылок по запросу в полях `original_url` или `short_code`.
- **Параметры запроса (Query):**
  - `query` (string) — поисковая строка.
  - `skip` (integer, опционально, по умолчанию `0`) — смещение.
  - `limit` (integer, опционально, по умолчанию `10`) — количество результатов.
- **Аутентификация:** Опционально. Если пользователь аутентифицирован, возвращаются как публичные, так и принадлежащие пользователю ссылки; иначе – только публичные.
- **Ответ:** Массив объектов ссылок.

---

#### Получение ссылок по категории
- **Метод:** `GET`
- **Путь:** `/category/{category}`
- **Описание:** Получение списка ссылок, отфильтрованных по указанной категории.
- **Аутентификация:** Опционально (аналогично поиску).
- **Ответ:** Массив объектов ссылок.

---

#### Получение статистики по ссылке
- **Метод:** `GET`
- **Путь:** `/{short_code}/stats`
- **Описание:** Получение детальной информации и статистики (количество редиректов, даты создания и т.д.) для ссылки по её короткому коду.
- **Ответ:** Объект ссылки со всеми полями.

---

#### Генерация QR-кода
- **Метод:** `GET`
- **Путь:** `/{short_code}/qrcode`
- **Описание:** Генерация и возврат QR-кода для ссылки в формате PNG.
- **Ответ:** Поток данных с изображением QR-кода.

---

#### Обновление ссылки
- **Метод:** `PUT`
- **Путь:** `/{short_code}`
- **Описание:** Обновление данных существующей ссылки. Обновление доступно только для владельца ссылки.
- **Аутентификация:** Требуется Bearer токен.
- **Тело запроса:** JSON с обновляемыми полями, аналогичными схеме создания ссылки.
- **Ответ:** Обновлённый объект ссылки.

---

#### Удаление ссылки
- **Метод:** `DELETE`
- **Путь:** `/{short_code}`
- **Описание:** Удаление ссылки. Доступно только владельцу.
- **Аутентификация:** Требуется Bearer токен.
- **Ответ:** JSON с сообщением об успешном удалении.

---

#### Редирект по короткому коду
- **Метод:** `GET`
- **Путь:** `/{short_code}`
- **Описание:** Перенаправляет запрос на оригинальный URL, увеличивая счётчик редиректов и обновляя время последнего редиректа.
- **Ответ:** HTTP-редирект на оригинальный URL.

---

### Фоновые задачи

Для поддержки актуальности данных используются фоновые задачи, запускаемые через Celery:

- **cleanup_expired_links_task**: Удаляет ссылки, у которых истёк срок действия (`expires_at` меньше текущей даты).
- **cleanup_inactive_links_task**: Удаляет неактивные ссылки (если с момента последнего редиректа или создания прошло более заданного количества дней).

---

